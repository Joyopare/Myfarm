{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Payment Method - Farm Market{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0"><i class="fas fa-credit-card me-2"></i>Payment Method</h4>
                </div>
                <div class="card-body p-4">
                    <!-- Order Summary -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5>Order Summary</h5>
                            <div class="bg-light p-3 rounded">
                                <p class="mb-1"><strong>Order #:</strong> {{ order.order_number }}</p>
                                <p class="mb-1"><strong>Items:</strong> {{ order.items.count }}</p>
                                <p class="mb-1"><strong>Delivery:</strong> {{ order.get_delivery_option_display }}</p>
                                <hr>
                                <h5 class="text-success mb-0"><strong>Total: ${{ order.total_amount }}</strong></h5>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h5>Delivery Address</h5>
                            <div class="bg-light p-3 rounded">
                                <p class="mb-0">{{ order.delivery_address }}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Methods -->
                    <h5 class="mb-3">Select Payment Method</h5>
                    <div class="payment-methods">
                        <!-- Credit/Debit Card -->
                        <div class="payment-option mb-3">
                            <div class="card border-2" id="card-payment">
                                <div class="card-body">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="payment_method" id="credit_card" value="credit_card" checked>
                                        <label class="form-check-label" for="credit_card">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-credit-card fa-2x text-primary me-3"></i>
                                                <div>
                                                    <h6 class="mb-1">Credit/Debit Card</h6>
                                                    <small class="text-muted">Visa, Mastercard, American Express</small>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                    
                                    <!-- Stripe Card Element -->
                                    <div class="mt-3" id="card-element-container">
                                        <div class="form-group">
                                            <label class="form-label">Card Details</label>
                                            <div id="card-element" class="form-control" style="height: 40px; padding: 10px;">
                                                <!-- Stripe Elements will create form elements here -->
                                            </div>
                                            <div id="card-errors" role="alert" class="text-danger mt-2"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Mobile Money -->
                        <div class="payment-option mb-3">
                            <div class="card border-2" id="mobile-money">
                                <div class="card-body">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="payment_method" id="mobile_money_radio" value="mobile_money">
                                        <label class="form-check-label" for="mobile_money">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-mobile-alt fa-2x text-warning me-3"></i>
                                                <div>
                                                    <h6 class="mb-1">Mobile Money</h6>
                                                    <small class="text-muted">MTN, Vodafone, AirtelTigo</small>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                    
                                    <div class="mt-3 d-none" id="mobile-money-details">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">Provider</label>
                                                <select class="form-select" name="mobile_provider">
                                                    <option value="">Select Provider</option>
                                                    <option value="mtn">MTN Mobile Money</option>
                                                    <option value="vodafone">Vodafone Cash</option>
                                                    <option value="airteltigo">AirtelTigo Money</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Phone Number</label>
                                                <input type="tel" class="form-control" name="mobile_number" placeholder="0XX XXX XXXX">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Cash on Delivery -->
                        <div class="payment-option mb-3">
                            <div class="card border-2" id="cash-delivery">
                                <div class="card-body">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="payment_method" id="cash_on_delivery" value="cash_on_delivery">
                                        <label class="form-check-label" for="cash_on_delivery">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-money-bill-wave fa-2x text-success me-3"></i>
                                                <div>
                                                    <h6 class="mb-1">Cash on Delivery</h6>
                                                    <small class="text-muted">Pay when you receive your order</small>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="{% url 'orders:checkout' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Back to Checkout
                        </a>
                        <button type="button" id="submit-payment" class="btn btn-success btn-lg">
                            <span class="spinner-border spinner-border-sm d-none" id="payment-spinner"></span>
                            <i class="fas fa-lock me-2"></i>Complete Payment (${{ order.total_amount }})
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Payment Success Modal -->
<div class="modal fade" id="paymentSuccessModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <i class="fas fa-check-circle fa-4x text-success mb-3"></i>
                <h4>Payment Successful!</h4>
                <p class="text-muted">Your order has been confirmed and will be processed shortly.</p>
                <a href="{% url 'orders:order_confirmation' order.order_number %}" class="btn btn-success">
                    View Order Details
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Payment Error Modal -->
<div class="modal fade" id="paymentErrorModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <i class="fas fa-exclamation-triangle fa-4x text-danger mb-3"></i>
                <h4>Payment Failed</h4>
                <p class="text-muted" id="error-message">There was an error processing your payment. Please try again.</p>
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">
                    Try Again
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://js.stripe.com/v3/"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Helper function to get CSRF token
    function getCsrfToken() {
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        return csrfInput ? csrfInput.value : '';
    }
    
    // Initialize Stripe
    const stripe = Stripe('{{ stripe_publishable_key }}');
    const elements = stripe.elements();
    
    // Create card element
    const cardElement = elements.create('card', {
        style: {
            base: {
                fontSize: '16px',
                color: '#424770',
                '::placeholder': {
                    color: '#aab7c4',
                },
            },
        },
    });
    
    cardElement.mount('#card-element');
    
    // Handle card errors
    cardElement.on('change', function(event) {
        const displayError = document.getElementById('card-errors');
        if (event.error) {
            displayError.textContent = event.error.message;
        } else {
            displayError.textContent = '';
        }
    });
    
    // Payment method selection
    const paymentMethods = document.querySelectorAll('input[name="payment_method"]');
    const cardContainer = document.getElementById('card-element-container');
    const mobileMoneyDetails = document.getElementById('mobile-money-details');
    
    paymentMethods.forEach(method => {
        method.addEventListener('change', function() {
            // Hide all payment details
            cardContainer.style.display = 'none';
            mobileMoneyDetails.classList.add('d-none');
            
            // Show relevant payment details
            if (this.value === 'credit_card') {
                cardContainer.style.display = 'block';
            } else if (this.value === 'mobile_money') {
                mobileMoneyDetails.classList.remove('d-none');
            }
            
            // Update card borders
            document.querySelectorAll('.payment-option .card').forEach(card => {
                card.classList.remove('border-success');
            });
            this.closest('.card').classList.add('border-success');
        });
    });
    
    // Initialize with credit card selected
    document.getElementById('credit_card').dispatchEvent(new Event('change'));
    
    // Handle payment submission
    document.getElementById('submit-payment').addEventListener('click', async function() {
        const selectedMethod = document.querySelector('input[name="payment_method"]:checked').value;
        const spinner = document.getElementById('payment-spinner');
        const button = this;
        
        // Show loading state
        spinner.classList.remove('d-none');
        button.disabled = true;
        
        try {
            if (selectedMethod === 'credit_card') {
                await processCardPayment();
            } else if (selectedMethod === 'mobile_money') {
                await processMobileMoneyPayment();
            } else if (selectedMethod === 'cash_on_delivery') {
                await processCashOnDelivery();
            }
        } catch (error) {
            showErrorModal(error.message);
        } finally {
            // Hide loading state
            spinner.classList.add('d-none');
            button.disabled = false;
        }
    });
    
    async function processCardPayment() {
        try {
            // Create payment intent
            const response = await fetch('/orders/create-payment-intent/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken(),
                },
                body: JSON.stringify({
                    order_number: '{{ order.order_number }}',
                    payment_method: 'credit_card'
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                console.error('Server returned non-JSON response:', text);
                throw new Error('Server error - please try again');
            }
            
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.error || 'Payment processing failed');
            }
            
            // Confirm payment with Stripe
            const {error, paymentIntent} = await stripe.confirmCardPayment(data.client_secret, {
                payment_method: {
                    card: cardElement,
                    billing_details: {
                        name: '{{ user.get_full_name }}',
                        email: '{{ user.email }}',
                    },
                }
            });
            
            if (error) {
                throw new Error(error.message);
            }
            
            if (paymentIntent.status === 'succeeded') {
                // Confirm payment on server
                await confirmPayment(paymentIntent.id);
                showSuccessModal();
            }
        } catch (error) {
            throw error;
        }
    }
    
    async function processMobileMoneyPayment() {
        const providerElement = document.querySelector('select[name="mobile_provider"]');
        const phoneElement = document.querySelector('input[name="mobile_number"]');
        
        const provider = providerElement ? providerElement.value : '';
        const phoneNumber = phoneElement ? phoneElement.value : '';
        
        if (!provider || !phoneNumber) {
            throw new Error('Please provide mobile money provider and phone number');
        }
        
        const response = await fetch('/orders/process-mobile-payment/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken(),
            },
            body: JSON.stringify({
                order_number: '{{ order.order_number }}',
                payment_method: 'mobile_money',
                provider: provider,
                phone_number: phoneNumber
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            console.error('Server returned non-JSON response:', text);
            throw new Error('Server error - please try again');
        }
        
        const data = await response.json();
        
        if (data.success) {
            showSuccessModal();
        } else {
            throw new Error(data.error || 'Mobile money payment failed');
        }
    }
    
    async function processCashOnDelivery() {
        const response = await fetch('/orders/process-cod-payment/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken(),
            },
            body: JSON.stringify({
                order_number: '{{ order.order_number }}',
                payment_method: 'cash_on_delivery'
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            console.error('Server returned non-JSON response:', text);
            throw new Error('Server error - please try again');
        }
        
        const data = await response.json();
        
        if (data.success) {
            showSuccessModal();
        } else {
            throw new Error(data.error || 'Cash on delivery setup failed');
        }
    }
    
    async function confirmPayment(paymentIntentId) {
        const response = await fetch('/orders/confirm-payment/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken(),
            },
            body: JSON.stringify({
                payment_intent_id: paymentIntentId,
                order_number: '{{ order.order_number }}'
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            console.error('Server returned non-JSON response:', text);
            throw new Error('Server error - please try again');
        }
        
        const data = await response.json();
        if (!data.success) {
            throw new Error('Payment confirmation failed');
        }
    }
    
    function showSuccessModal() {
        const modal = new bootstrap.Modal(document.getElementById('paymentSuccessModal'));
        modal.show();
    }
    
    function showErrorModal(message) {
        document.getElementById('error-message').textContent = message;
        const modal = new bootstrap.Modal(document.getElementById('paymentErrorModal'));
        modal.show();
    }
});
</script>
{% endblock %}
